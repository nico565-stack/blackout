<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BLACKOUT</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      font-family: system-ui, -apple-system, Arial, sans-serif;
    }

    .screen {
      height: 100%;
      display: grid;
      place-items: center;
    }

    /* START SCREEN */
    #start {
      background: #0b0b0b;
      color: #eaeaea;
      text-align: center;
    }
    #start h1 { margin-bottom: 12px; letter-spacing: 4px; }
    #start p { opacity: .8; line-height: 1.4; }

    button {
      margin-top: 18px;
      padding: 14px 22px;
      font-size: 16px;
      border-radius: 16px;
      border: none;
      cursor: pointer;
    }
    .hint { margin-top: 12px; font-size: 13px; opacity: .6; }

    /* BLACKOUT */
    #blackout {
      background: #000;
      color: #39ff14;
      position: relative;
      overflow: hidden;
    }

    /* TIMER CENTRALE FLUORESCENTE CHE RESPIRA */
    .timer {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 68px;
      font-weight: 700;
      letter-spacing: 6px;
      user-select: none;
      color: #39ff14;
      animation: breatheNeon 11s ease-in-out infinite;
    }

    @keyframes breatheNeon {
      0% {
        opacity: 0.75;
        text-shadow:
          0 0 6px rgba(57,255,20,.35),
          0 0 18px rgba(57,255,20,.25),
          0 0 32px rgba(57,255,20,.15);
      }
      40% {
        opacity: 1;
        text-shadow:
          0 0 10px rgba(57,255,20,.85),
          0 0 26px rgba(57,255,20,.75),
          0 0 60px rgba(57,255,20,.55);
      }
      100% {
        opacity: 0.75;
        text-shadow:
          0 0 6px rgba(57,255,20,.35),
          0 0 18px rgba(57,255,20,.25),
          0 0 32px rgba(57,255,20,.15);
      }
    }

    .exit {
      position: absolute;
      bottom: 16px;
      left: 16px;
      font-size: 12px;
      opacity: .18;
      user-select: none;
      color: #aaa;
    }

    /* END */
    #end {
      background: #fff;
      color: #111;
      text-align: center;
    }
    #end p { font-size: 20px; margin: 0; }
    #end .small { margin-top: 10px; font-size: 12px; opacity: .6; }
  </style>
</head>

<body>

  <!-- START -->
  <div id="start" class="screen">
    <div>
      <h1>BLACKOUT</h1>
      <p>
        Esperimento proibito.<br>
        Accesso volontario.<br>
        Durata variabile.
      </p>
      <button id="btnStart">INIZIA</button>
      <div class="hint">Questo non è un errore. Quando inizi, non acceleri.</div>
    </div>
  </div>

  <!-- BLACKOUT -->
  <div id="blackout" class="screen" style="display:none;">
    <div class="timer" id="timer">--:--</div>
    <div class="exit">Uscire adesso = esperienza incompleta</div>
  </div>

  <!-- END -->
  <div id="end" class="screen" style="display:none;">
    <div>
      <p><strong>Ora sai quanto rumore c’era.</strong></p>
      <div class="small">Fine.</div>
    </div>
  </div>

<script>
(() => {
  const startEl = document.getElementById("start");
  const blackoutEl = document.getElementById("blackout");
  const endEl = document.getElementById("end");
  const timerEl = document.getElementById("timer");
  const btnStart = document.getElementById("btnStart");

  let audioCtx, noiseNode, noiseGain, masterGain;
  let intervalId, timeoutId;

  const pad = n => String(n).padStart(2, "0");

  /* AUDIO – RESPIRO */
  function startBreath() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0;
    masterGain.connect(audioCtx.destination);

    const bufferSize = audioCtx.sampleRate * 2;
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;

    noiseNode = audioCtx.createBufferSource();
    noiseNode.buffer = buffer;
    noiseNode.loop = true;

    const filter = audioCtx.createBiquadFilter();
    filter.type = "bandpass";
    filter.frequency.value = 500;
    filter.Q.value = 1;

    noiseGain = audioCtx.createGain();
    noiseGain.gain.value = 0;

    noiseNode.connect(filter);
    filter.connect(noiseGain);
    noiseGain.connect(masterGain);

    noiseNode.start();
    masterGain.gain.linearRampToValueAtTime(0.18, audioCtx.currentTime + 2);

    const inhale = 4, hold = 1, exhale = 6;
    let t = audioCtx.currentTime;
    for (let i = 0; i < 60; i++) {
      noiseGain.gain.setValueAtTime(0.02, t);
      noiseGain.gain.linearRampToValueAtTime(0.12, t + inhale);
      noiseGain.gain.setValueAtTime(0.12, t + inhale + hold);
      noiseGain.gain.linearRampToValueAtTime(0.02, t + inhale + hold + exhale);
      t += inhale + hold + exhale;
    }
  }

  function stopBreath() {
    if (!audioCtx) return;
    masterGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.2);
    setTimeout(() => audioCtx.close(), 1300);
  }

  /* TIMER BLACKOUT */
  function runBlackout() {
    const totalSec = Math.floor(6 * 60 + Math.random() * (8 * 60 + 1)); // 6–14 min
    const startTime = Date.now();

    function tick() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const left = Math.max(0, totalSec - elapsed);
      timerEl.textContent = `${pad(Math.floor(left / 60))}:${pad(left % 60)}`;
    }

    tick();
    intervalId = setInterval(tick, 250);

    timeoutId = setTimeout(() => {
      clearInterval(intervalId);
      stopBreath();
      blackoutEl.style.display = "none";
      endEl.style.display = "grid";
      history.pushState(null, "", "#done");
    }, totalSec * 1000);
  }

  btnStart.addEventListener("click", () => {
    startEl.style.display = "none";
    blackoutEl.style.display = "grid";
    startBreath();
    runBlackout();
  });

  window.addEventListener("beforeunload", (e) => {
    if (blackoutEl.style.display !== "none") {
      e.preventDefault();
      e.returnValue = "";
    }
  });
})();
</script>

</body>
</html>
